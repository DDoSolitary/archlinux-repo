diff --git a/.SRCINFO b/.SRCINFO
index 67051fd..b08a385 100644
--- a/.SRCINFO
+++ b/.SRCINFO
@@ -23,11 +23,15 @@ pkgbase = shadowsocksr-libev-git
 	source = shadowsocksr-libev-server@.service
 	source = shadowsocksr-libev-tunnel@.service
 	source = shadowsocksr-libev@.service
+	source = fix-multiple-definition.patch
+	source = warning-no-error.patch
 	sha256sums = SKIP
 	sha256sums = 8d27cf80278bff1055ab208ccc9eab04193fea34a5c18b778647f46e87371153
 	sha256sums = 32ca7d65d78bf31d6787b19b22c8aed0d2fe2ad2790a5ca9f315033cbe23393d
 	sha256sums = 46fce883f20f705d346a8f1128ae31b421553d86045ef47eadafc96390f32c1a
 	sha256sums = 0e341beeeaef04c1ee952a33ac7db86b65cfd5867082c73c67f457a50a3d7fdd
+	sha256sums = 99c34f0675c9b1687844cbb7f107af3ca3564c99e12252ef07d26573e1bf9ad8
+	sha256sums = b6ce119f1d338f1c52f50f544cc138a1cb4aa84e81cf8fecb4da18ca63cd1108
 
 pkgname = shadowsocksr-libev-git
 
diff --git a/PKGBUILD b/PKGBUILD
index 4368871..e3693a9 100644
--- a/PKGBUILD
+++ b/PKGBUILD
@@ -18,12 +18,16 @@ source=(
         shadowsocksr-libev-server@.service
         shadowsocksr-libev-tunnel@.service
         shadowsocksr-libev@.service
+        fix-multiple-definition.patch
+        warning-no-error.patch
         )
 sha256sums=('SKIP'
             '8d27cf80278bff1055ab208ccc9eab04193fea34a5c18b778647f46e87371153'
             '32ca7d65d78bf31d6787b19b22c8aed0d2fe2ad2790a5ca9f315033cbe23393d'
             '46fce883f20f705d346a8f1128ae31b421553d86045ef47eadafc96390f32c1a'
-            '0e341beeeaef04c1ee952a33ac7db86b65cfd5867082c73c67f457a50a3d7fdd')
+            '0e341beeeaef04c1ee952a33ac7db86b65cfd5867082c73c67f457a50a3d7fdd'
+            '99c34f0675c9b1687844cbb7f107af3ca3564c99e12252ef07d26573e1bf9ad8'
+            'b6ce119f1d338f1c52f50f544cc138a1cb4aa84e81cf8fecb4da18ca63cd1108')
 
 _gitname='shadowsocksr-libev'
 
@@ -34,6 +38,8 @@ pkgver() {
 
 build() {
   cd "$_gitname"
+  patch -Np1 -i "$srcdir"/fix-multiple-definition.patch
+  patch -Np1 -i "$srcdir"/warning-no-error.patch
   ./configure --prefix=/opt/$_gitname \
               --enable-system-shared-lib \
               --program-transform-name='s/ss-/ssr-/' # \
diff --git a/fix-multiple-definition.patch b/fix-multiple-definition.patch
new file mode 100644
index 0000000..7a480f1
--- /dev/null
+++ b/fix-multiple-definition.patch
@@ -0,0 +1,24 @@
+diff --git a/src/http.h b/src/http.h
+index 914815a..e312dd3 100644
+--- a/src/http.h
++++ b/src/http.h
+@@ -29,6 +29,6 @@
+ #include <stdio.h>
+ #include "protocol.h"
+ 
+-const protocol_t *const http_protocol;
++extern const protocol_t *const http_protocol;
+ 
+ #endif
+diff --git a/src/tls.h b/src/tls.h
+index 3998913..ddbee11 100644
+--- a/src/tls.h
++++ b/src/tls.h
+@@ -28,6 +28,6 @@
+ 
+ #include "protocol.h"
+ 
+-const protocol_t *const tls_protocol;
++extern const protocol_t *const tls_protocol;
+ 
+ #endif
diff --git a/warning-no-error.patch b/warning-no-error.patch
new file mode 100644
index 0000000..7e6d715
--- /dev/null
+++ b/warning-no-error.patch
@@ -0,0 +1,31 @@
+diff --git a/src/Makefile.am b/src/Makefile.am
+index eea1300..67acb34 100644
+--- a/src/Makefile.am
++++ b/src/Makefile.am
+@@ -1,6 +1,6 @@
+ VERSION_INFO = 2:0:0
+ 
+-AM_CFLAGS = -g -O2 -Wall -Werror -Wno-deprecated-declarations -fno-strict-aliasing -std=gnu99 -D_GNU_SOURCE
++AM_CFLAGS = -g -O2 -Wall -Werror -Wno-error=format-truncation -Wno-error=format-overflow -Wno-error=stringop-truncation -Wno-error=sizeof-pointer-memaccess -Wno-deprecated-declarations -fno-strict-aliasing -std=gnu99 -D_GNU_SOURCE
+ AM_CFLAGS += $(PTHREAD_CFLAGS)
+ if !USE_SYSTEM_SHARED_LIB
+ AM_CFLAGS += -I$(top_srcdir)/libev
+diff --git a/src/Makefile.in b/src/Makefile.in
+index 66fac07..dd195cd 100644
+--- a/src/Makefile.in
++++ b/src/Makefile.in
+@@ -433,9 +433,11 @@ top_build_prefix = @top_build_prefix@
+ top_builddir = @top_builddir@
+ top_srcdir = @top_srcdir@
+ VERSION_INFO = 2:0:0
+-AM_CFLAGS = -g -O2 -Wall -Werror -Wno-deprecated-declarations \
+-	-fno-strict-aliasing -std=gnu99 -D_GNU_SOURCE \
+-	$(PTHREAD_CFLAGS) $(am__append_1) \
++AM_CFLAGS = -g -O2 -Wall -Werror -Wno-error=format-truncation \
++	-Wno-error=format-overflow -Wno-error=stringop-truncation \
++	-Wno-error=sizeof-pointer-memaccess \
++	-Wno-deprecated-declarations -fno-strict-aliasing -std=gnu99 \
++	-D_GNU_SOURCE $(PTHREAD_CFLAGS) $(am__append_1) \
+ 	-I$(top_srcdir)/libipset/include \
+ 	-I$(top_srcdir)/libcork/include $(LIBPCRE_CFLAGS)
+ SS_COMMON_LIBS = $(top_builddir)/libipset/libipset.la \
